<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h2 {
            font-size: 42px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .filters input,
        .filters select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filters input:focus,
        .filters select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters input {
            flex: 1;
            min-width: 250px;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #f8f9fa;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Status Badge */
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* Buttons */
        button {
            padding: 10px 18px;
            margin: 0 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pagination span {
            font-weight: 600;
            color: #333;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Login Form */
        .login-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .login-form h2 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-block {
            width: 100%;
            padding: 14px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Login Form (shown if not logged in) -->
    <div id="loginForm" class="login-form" style="display: none;">
        <h2>üîê Admin Login</h2>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="loginEmail" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter your password">
        </div>
        <button class="btn-primary btn-block" onclick="handleLogin()">Login</button>
    </div>

    <!-- OTP Form (shown after login) -->
    <div id="otpForm" class="login-form" style="display: none;">
        <h2>üìß Enter OTP</h2>
        <p style="text-align: center; margin-bottom: 20px; color: #666;">
            We've sent a verification code to your email
        </p>
        <div class="form-group">
            <label>OTP Code:</label>
            <input type="text" id="otpCode" placeholder="Enter 6-digit code" maxlength="6">
        </div>
        <button class="btn-primary btn-block" onclick="handleVerifyOTP()">Verify</button>
    </div>

    <!-- Main Dashboard (shown after successful login) -->
    <div id="dashboard" class="container" style="display: none;">
        <h1>üë• User Management Dashboard</h1>
        <p class="subtitle">Manage all users, roles, and permissions</p>
        
        <!-- Statistics Section -->
        <div id="statistics">
            <h2 style="margin-bottom: 20px;">üìä Statistics</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="loading">Loading statistics</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters">
            <input type="text" id="searchInput" placeholder="üîç Search by email or name...">
            <select id="roleFilter">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
                <option value="moderator">Moderator</option>
            </select>
            <select id="statusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
            <button class="btn-primary" onclick="loadUsers()">Search</button>
            <button class="btn-danger" onclick="handleLogout()">Logout</button>
        </div>

        <!-- Users Table -->
        <div id="usersTable">
            <div class="loading">Loading users</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        const APP_ID = 'default_app_id';
        const SERVICE_KEY = 'default_service_key';
        
        let jwtToken = localStorage.getItem('jwt_token') || '';
        let currentEmail = '';
        let currentPage = 1;

        // Initialize page
        window.onload = function() {
            if (jwtToken) {
                showDashboard();
                loadStatistics();
                loadUsers();
            } else {
                showLoginForm();
            }
        };

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('otpForm').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showOTPForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('otpForm').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('otpForm').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        // Get headers
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${jwtToken}`
            };
        }

        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-App-Id': APP_ID,
                'X-Service-Key': SERVICE_KEY
            };
        }

        // Handle login
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (result.success) {
                    currentEmail = email;
                    alert('OTP sent to your email!');
                    showOTPForm();
                } else {
                    alert('Login failed: ' + result.message);
                }
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        }

        // Handle OTP verification
        async function handleVerifyOTP() {
            const otpCode = document.getElementById('otpCode').value;

            if (!otpCode || otpCode.length !== 6) {
                alert('Please enter a valid 6-digit OTP code');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/verify-otp`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ 
                        email: currentEmail, 
                        otpCode: otpCode 
                    })
                });

                const result = await response.json();

                if (result.success && result.token) {
                    jwtToken = result.token;
                    localStorage.setItem('jwt_token', jwtToken);
                    alert('Login successful!');
                    showDashboard();
                    loadStatistics();
                    loadUsers();
                } else {
                    alert('OTP verification failed: ' + result.message);
                }
            } catch (error) {
                alert('Verification error: ' + error.message);
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: getHeaders()
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                jwtToken = '';
                localStorage.removeItem('jwt_token');
                showLoginForm();
            }
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/user-management/statistics`, {
                    headers: getHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data.overview;
                    document.getElementById('statsGrid').innerHTML = `
                        <div class="stat-card">
                            <h2>${stats.totalUsers}</h2>
                            <p>Total Users</p>
                        </div>
                        <div class="stat-card">
                            <h2>${stats.activeUsers}</h2>
                            <p>Active Users</p>
                        </div>
                        <div class="stat-card">
                            <h2>${stats.inactiveUsers}</h2>
                            <p>Inactive Users</p>
                        </div>
                        <div class="stat-card">
                            <h2>${stats.recentRegistrations}</h2>
                            <p>Recent Registrations (30d)</p>
                        </div>
                        <div class="stat-card">
                            <h2>${stats.recentActiveLogins}</h2>
                            <p>Recent Active Logins (7d)</p>
                        </div>
                    `;
                } else {
                    document.getElementById('statsGrid').innerHTML = '<p>Failed to load statistics</p>';
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
                document.getElementById('statsGrid').innerHTML = '<p>Error loading statistics</p>';
            }
        }

        // Load users
        async function loadUsers(page = 1) {
            try {
                currentPage = page;
                const search = document.getElementById('searchInput').value;
                const role = document.getElementById('roleFilter').value;
                const status = document.getElementById('statusFilter').value;
                
                const params = new URLSearchParams({ page, limit: 20, search, role, status });
                
                const response = await fetch(`${API_BASE}/user-management/users?${params}`, {
                    headers: getHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayUsers(result.data.users, result.data.pagination);
                } else {
                    document.getElementById('usersTable').innerHTML = '<p>Failed to load users</p>';
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersTable').innerHTML = '<p>Error loading users</p>';
            }
        }

        // Display users in table
        function displayUsers(users, pagination) {
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td><strong>${user.id}</strong></td>
                                <td>${user.email}</td>
                                <td>${user.first_name || ''} ${user.last_name || ''}</td>
                                <td><strong>${user.role.toUpperCase()}</strong></td>
                                <td><span class="status-badge ${user.status}">${user.status}</span></td>
                                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                                <td>
                                    ${user.status === 'inactive' 
                                        ? `<button class="btn-success" onclick="activateUser(${user.id})">‚úì Activate</button>`
                                        : `<button class="btn-warning" onclick="deactivateUser(${user.id})">‚äó Deactivate</button>`
                                    }
                                    <button class="btn-info" onclick="sendPasswordReset(${user.id})">üîë Reset Password</button>
                                    <button class="btn-danger" onclick="deleteUser(${user.id}, '${user.email}')">üóë Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="pagination">
                    <button class="btn-primary" ${pagination.page === 1 ? 'disabled' : ''} onclick="loadUsers(${pagination.page - 1})">‚Üê Previous</button>
                    <span>Page ${pagination.page} of ${pagination.totalPages} | Total: ${pagination.total} users</span>
                    <button class="btn-primary" ${pagination.page === pagination.totalPages ? 'disabled' : ''} onclick="loadUsers(${pagination.page + 1})">Next ‚Üí</button>
                </div>
            `;
            
            document.getElementById('usersTable').innerHTML = tableHTML;
        }

        // Activate user
        async function activateUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/user-management/users/${userId}/activate`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ User activated successfully!');
                    loadUsers(currentPage);
                    loadStatistics();
                } else {
                    alert('‚ùå Failed to activate user: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Deactivate user
        async function deactivateUser(userId) {
            const reason = prompt('Enter reason for deactivation:');
            if (!reason) return;
            
            try {
                const response = await fetch(`${API_BASE}/user-management/users/${userId}/deactivate`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ reason })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ User deactivated successfully!');
                    loadUsers(currentPage);
                    loadStatistics();
                } else {
                    alert('‚ùå Failed to deactivate user: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Send password reset
        async function sendPasswordReset(userId) {
            try {
                const response = await fetch(`${API_BASE}/user-management/users/${userId}/send-password-reset`, {
                    method: 'POST',
                    headers: getHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Password reset email sent to ${result.data.email}`);
                } else {
                    alert('‚ùå Failed to send password reset: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Delete user
        async function deleteUser(userId, email) {
            const confirmed = confirm(`‚ö†Ô∏è Are you sure you want to delete user "${email}"?\n\nThis action CANNOT be undone!`);
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_BASE}/user-management/users/${userId}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ User deleted successfully!');
                    loadUsers(currentPage);
                    loadStatistics();
                } else {
                    alert('‚ùå Failed to delete user: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Enter key handlers
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('loginForm').style.display !== 'none') {
                    handleLogin();
                } else if (document.getElementById('otpForm').style.display !== 'none') {
                    handleVerifyOTP();
                }
            }
        });
    </script>
</body>
</html>



